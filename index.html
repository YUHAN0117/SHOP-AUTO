<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>精選導購商品</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#fff; text-align:center; }
    h1 { margin:20px 0; }
    .grid { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; }
    .card { background:#222; border-radius:10px; padding:10px; width:200px; }
    .card img { width:100%; height:200px; object-fit:cover; border-radius:8px; }
    .card h3 { font-size:16px; margin:10px 0; }
    .price { color:#0f0; font-weight:bold; margin:5px 0; }
    .btn { display:inline-block; background:#007bff; color:#fff; padding:8px 12px; border-radius:5px; text-decoration:none; }
    .btn:hover { background:#0056b3; }
    .rating { color:#ffcc00; font-size:14px; margin:5px 0; }
    .category { font-size:13px; color:#aaa; margin:5px 0; }
    .empty { margin:30px auto; color:#aaa; }
  </style>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-0XBJ4VCQSM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-0XBJ4VCQSM');
  </script>
</head>
<body>
  <h1>🔥 精選導購商品 🔥</h1>
  <div class="grid" id="productGrid">載入中...</div>

  <script>
    // 內建SVG後備圖（不用額外檔案也能顯示）
    const FALLBACK_DATAURI =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400">
  <rect width="100%" height="100%" fill="#0b1017"/>
  <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
        font-family="Arial" font-size="22" fill="#7c8796">No Image</text>
</svg>`);

    // CSV 轉換函式
    function parseCSV(text) {
      const lines = text.trim().split("\n");
      const headers = lines[0].split(",");
      return lines.slice(1).map(line => {
        const values = line.split(",");
        let obj = {};
        headers.forEach((h, i) => obj[h.trim()] = values[i] ? values[i].trim() : "");
        return obj;
      });
    }

    // 生成商品卡片
    function renderProducts(list){
      const grid = document.getElementById('productGrid');
      grid.innerHTML = '';
      let shown = 0;

      list.forEach(p=>{
        const act = String(p.active||'').toLowerCase();
        if(act && act!=='false' && act!=='0'){
          const imgUrl = (p.image || '').trim();
          const title  = (p.title || '').trim();
          const price  = p.price ? 'NT$'+p.price : '';
          const rating = p.rating ? '⭐ '+p.rating : '';
          const cats   = [p.category, p.tags].filter(Boolean).join('｜');
          const url    = (p.affiliate_url || '#').trim();

          grid.insertAdjacentHTML('beforeend', `
            <div class="card">
              <img class="thumb" src="${imgUrl || FALLBACK_DATAURI}" alt="${title}"
                   onerror="console.warn('Image failed:', '${title}', this.src); this.onerror=null; this.src='${FALLBACK_DATAURI}';">
              <h3>${title}</h3>
              <p class="price">${price}</p>
              <p class="rating">${rating}</p>
              <p class="category">分類：${cats}</p>
              <a class="btn" href="${url}" target="_blank" rel="nofollow noopener">前往購買</a>
            </div>
          `);
          shown++;
        }
      });

      if(!shown){
        grid.innerHTML = '<div class="empty">（沒有可顯示的商品）</div>';
      }
    }

    // 載入 CSV
    fetch("data/products.csv")
      .then(res => res.text())
      .then(text => {
        const products = parseCSV(text);
        renderProducts(products);
      })
      .catch(err => {
        document.getElementById("productGrid").innerHTML = "❌ 載入商品資料失敗：" + err;
      });
  </script>
</body>
</html>
